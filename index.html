<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Calendario de Turnos Profesional</title>
    
    <!-- Enlace al Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Meta tags para PWA en iOS y color de la barra de estado -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Turnos Pro">
    <meta name="theme-color" content="#4f46e5">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; /* Gap reducido */ }
        .day-cell {
            aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 0.5rem; font-size: 1.1rem; /* Aumentado */
            font-weight: 500; transition: all 0.2s ease-in-out; line-height: 1.2;
        }
        .day-name { font-weight: bold; text-align: center; }
        .free-day { font-weight: bold; } /* Color se aplica dinámicamente */
        .assigned-shift { font-weight: bold; }
        .assigned-shift .day-number { font-size: 1.3em; }
        .assigned-shift .shift-name-label { font-size: 0.8em; margin-top: 3px; word-break: break-all; }
        .today { position: relative; ring-width: 3px; --tw-ring-color: #4f46e5; box-shadow: 0 0 0 3px var(--tw-ring-color); }
        .dark .today { --tw-ring-color: #818cf8; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .calendar-container { animation: fadeIn 0.5s ease-out forwards; }
        #side-menu { transition: transform 0.3s ease-in-out; }
        .draggable-item.dragging { opacity: 0.4; background: #e0e7ff !important; }
        #shift-list.drag-enabled .draggable-item { cursor: grab; }
        #shift-list.drag-enabled .draggable-item:active { cursor: grabbing; }
        .drop-zone { height: 2.5rem; background-color: rgba(79, 70, 229, 0.1); border: 2px dashed #4f46e5; border-radius: 0.5rem; margin: 4px 0; animation: fadeIn 0.2s; }
        .toast {
            padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 500;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            animation: toast-in 0.3s ease-out forwards, toast-out 0.3s ease-in forwards 2.7s;
            opacity: 0; transform: translateY(20px); pointer-events: none;
        }
        .toast.success { background-color: #16a34a; }
        .toast.error { background-color: #dc2626; }
        .toast.info { background-color: #2563eb; }
        @keyframes toast-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }
    </style>
    <script>
        const matcher = window.matchMedia('(prefers-color-scheme: dark)');
        const applyTheme = (isDark) => { document.documentElement.classList.toggle('dark', isDark); };
        applyTheme(matcher.matches);
        matcher.addEventListener('change', e => applyTheme(e.matches));
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] space-y-2"></div>
    <aside id="side-menu" class="fixed top-0 left-0 h-full w-80 bg-white dark:bg-gray-800 shadow-xl z-50 transform -translate-x-full overflow-y-auto">
        <div class="p-6 space-y-6">
            <button onclick="closeMenu()" class="absolute top-4 right-4 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white text-2xl">&times;</button>
            <div class="border-b pb-6 border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">Perfiles</h2>
                <div id="profile-list" class="my-3 space-y-2"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-profile-name" placeholder="Nombre del perfil" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    <button onclick="addProfile()" class="bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-bold py-2 px-3 rounded-lg text-sm">Añadir</button>
                </div>
            </div>
            <div class="border-b pb-6 border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">Configuración del Ciclo</h2>
                <div class="space-y-4 mt-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Primer día del ciclo de descanso:</label>
                        <input type="date" id="referenceDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    </div>
                    <div>
                        <label for="freeDayColorInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Color del Día Libre:</label>
                        <input type="color" id="freeDayColorInput" onchange="updateFreeDayColor(this.value)" class="mt-1 w-full h-10 border-0 cursor-pointer rounded-lg">
                    </div>
                    <button onclick="initializeSchedule()" class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg">Establecer Ciclo</button>
                </div>
            </div>
            <div class="border-b pb-6 border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">Gestión de Turnos</h2>
                    <div class="flex items-center space-x-2">
                        <label for="enable-drag-checkbox" class="text-sm font-medium text-gray-600 dark:text-gray-400">Ordenar</label>
                        <input type="checkbox" id="enable-drag-checkbox" onchange="toggleDragMode(this.checked)" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    </div>
                </div>
                <button onclick="openImportModal()" class="w-full mb-3 bg-teal-600 hover:bg-teal-700 active:bg-teal-800 text-white text-sm font-bold py-2 px-4 rounded-lg">Importar de otro perfil...</button>
                <div id="shift-list" class="space-y-2"></div>
                 <div class="space-y-3 mt-3">
                     <input type="hidden" id="shift-id">
                     <input type="text" id="shift-name" placeholder="Ej: 17:30-01:30" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                     <input type="color" id="shift-color" value="#3b82f6" class="w-full h-10 border-0 cursor-pointer rounded-lg">
                     <button id="save-shift-btn" onclick="saveShift()" class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold py-2 px-4 rounded-lg">Agregar Turno</button>
                     <button id="cancel-edit-btn" onclick="cancelEdit()" class="w-full bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hidden">Cancelar</button>
                </div>
            </div>
            <div>
                 <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">Datos y Exportación</h2>
                 <div class="grid grid-cols-2 gap-3 mt-3">
                    <button onclick="backupData()" class="bg-gray-700 hover:bg-gray-800 active:bg-gray-900 text-white text-sm font-bold py-2 px-2 rounded-lg">Respaldar</button>
                    <button onclick="document.getElementById('restore-input').click()" class="bg-gray-700 hover:bg-gray-800 active:bg-gray-900 text-white text-sm font-bold py-2 px-2 rounded-lg">Restaurar</button>
                    <input type="file" id="restore-input" class="hidden" accept=".json" onchange="restoreData(event)">
                    <button onclick="exportToCSV()" class="bg-green-700 hover:bg-green-800 active:bg-green-900 text-white text-sm font-bold py-2 px-2 rounded-lg">Excel</button>
                    <button id="pdf-export-btn" onclick="exportToPDF()" class="bg-red-700 hover:bg-red-800 active:bg-red-900 text-white text-sm font-bold py-2 px-2 rounded-lg">PDF</button>
                 </div>
            </div>
        </div>
    </aside>
    <div id="menu-overlay" class="fixed inset-0 z-40 hidden bg-black/50 backdrop-blur-sm" onclick="closeMenu()"></div>

    <main id="main-content" class="py-2 px-1 sm:px-4">
        <div class="w-full max-w-full mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-2 sm:p-4 md:p-6">
            <header class="flex items-center justify-between text-center mb-4 sm:mb-8 border-b pb-4 border-gray-200 dark:border-gray-700">
                <button onclick="openMenu()" class="p-2 rounded-full hover:bg-gray-100 active:bg-gray-200 dark:hover:bg-gray-700 dark:active:bg-gray-600"><svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                <div class="flex flex-col items-center">
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-100">Calendario de Turnos</h1>
                    <p id="current-user-name" class="text-indigo-600 dark:text-indigo-400 font-semibold mt-1"></p>
                    <p id="countdown-container" class="text-sm text-gray-500 dark:text-gray-400 mt-2"></p>
                </div>
                <div class="w-10"></div>
            </header>
            <div id="calendar-view">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="navigateMonth(-1)" class="p-2 rounded-full hover:bg-gray-200 active:bg-gray-300 dark:hover:bg-gray-700 dark:active:bg-gray-600"><svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <select id="displayMonth" onchange="jumpToDate()" class="border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"></select>
                        <select id="displayYear" onchange="jumpToDate()" class="border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"></select>
                    </div>
                    <button onclick="navigateMonth(1)" class="p-2 rounded-full hover:bg-gray-200 active:bg-gray-300 dark:hover:bg-gray-700 dark:active:bg-gray-600"><svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                </div>
                <div id="calendar-wrapper"></div>
            </div>
        </div>
         <footer class="text-center py-8 text-sm text-gray-500 dark:text-gray-400">
            CarlosPN Interactive®
        </footer>
    </main>

    <div id="shiftModal" class="fixed inset-0 z-50 items-center justify-center hidden bg-gray-900/60 backdrop-blur-sm" onclick="closeModal(event)">
        <div id="modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-2 text-center text-gray-900 dark:text-gray-100">Asignar Turno</h3>
            <p id="modal-date" class="text-center text-gray-600 dark:text-gray-300 mb-4"></p>
            <div id="modal-shift-options" class="space-y-2"></div>
            <button onclick="removeShiftAssignment()" class="w-full mt-4 bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold py-2 px-4 rounded-lg">Quitar Turno</button>
            <button id="google-cal-btn" onclick="addToGoogleCalendar()" class="w-full mt-2 bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-400 dark:disabled:bg-gray-600">Añadir a Google Calendar</button>
        </div>
    </div>
    
    <div id="importShiftModal" class="fixed inset-0 z-50 items-center justify-center hidden bg-gray-900/60 backdrop-blur-sm" onclick="closeImportModal(event)">
        <div id="import-modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4 text-center text-gray-900 dark:text-gray-100">Importar Turnos de Perfil</h3>
            <div id="import-profile-options" class="space-y-2"></div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const dayNames = ["L", "M", "M", "J", "V", "S", "D"];
        const dayNamesFull = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
        
        let appData = {}, activeProfile = null, selectedDateForAssignment = null, currentDisplayYear, currentDisplayMonth;
        
        function showToast(message, type = 'success') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => { toast.remove(); }, 3000); }
        function getTextColorForBg(hexColor) { const r = parseInt(hexColor.slice(1, 3), 16), g = parseInt(hexColor.slice(3, 5), 16), b = parseInt(hexColor.slice(5, 7), 16); return (((r * 299) + (g * 587) + (b * 114)) / 1000) > 150 ? '#000000' : '#FFFFFF'; }
        function createDefaultProfile() { return { id: crypto.randomUUID(), name: 'Mi Calendario', shifts: [{id: crypto.randomUUID(), name: '17:30-01:30', color: '#4f46e5'}], assignedShifts: {}, referenceDate: new Date().toISOString(), freeDayColor: '#16a34a' }; }
        function loadFromLocalStorage() { try { const storedData = localStorage.getItem('calendarAppData_multiuser_v2'); appData = storedData ? JSON.parse(storedData) : { profiles: [createDefaultProfile()], activeProfileId: null }; if (!appData.profiles || appData.profiles.length === 0) { appData.profiles = [createDefaultProfile()]; } appData.activeProfileId = appData.activeProfileId || appData.profiles[0].id; activeProfile = appData.profiles.find(p => p.id === appData.activeProfileId) || appData.profiles[0]; if (!activeProfile.freeDayColor) { activeProfile.freeDayColor = '#16a34a'; } } catch (e) { console.error("Error al cargar datos:", e); appData = { profiles: [createDefaultProfile()], activeProfileId: null }; activeProfile = appData.profiles[0]; } }
        function saveToLocalStorage() { const index = appData.profiles.findIndex(p => p.id === activeProfile.id); if (index !== -1) { appData.profiles[index] = activeProfile; } localStorage.setItem('calendarAppData_multiuser_v2', JSON.stringify(appData)); }
        function switchProfile(profileId) { appData.activeProfileId = profileId; activeProfile = appData.profiles.find(p => p.id === profileId); saveToLocalStorage(); refreshAllUI(); closeMenu(); showToast(`Perfil '${activeProfile.name}' cargado.`, 'info'); }
        function addProfile() { const nameInput = document.getElementById('new-profile-name'); const name = nameInput.value.trim(); if (!name) return; const newProfile = createDefaultProfile(); newProfile.name = name; appData.profiles.push(newProfile); nameInput.value = ''; switchProfile(newProfile.id); showToast(`Perfil "${name}" añadido.`);}
        function deleteProfile(profileId) { if (appData.profiles.length <= 1) { showToast("No se puede borrar el último perfil.", "error"); return; } if (!confirm("¿Seguro que quieres borrar este perfil?")) return; const deletedProfileName = appData.profiles.find(p => p.id === profileId)?.name || 'desconocido'; appData.profiles = appData.profiles.filter(p => p.id !== profileId); if (appData.activeProfileId === profileId) { switchProfile(appData.profiles[0].id); } else { saveToLocalStorage(); refreshAllUI(); } showToast(`Perfil "${deletedProfileName}" borrado.`, 'info');}
        function refreshAllUI() { renderProfileManager(); renderShiftManager(); updateConfigControls(); renderCurrentCalendar(); updateCountdown(); document.getElementById('current-user-name').textContent = activeProfile.name; }
        
        function renderProfileManager() {
            const list = document.getElementById('profile-list'); list.innerHTML = '';
            appData.profiles.forEach(profile => {
                const isActive = profile.id === activeProfile.id;
                const el = document.createElement('div');
                el.className = `flex items-center justify-between p-2 rounded-lg cursor-pointer ${isActive ? 'bg-indigo-100 dark:bg-indigo-900/50' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                el.innerHTML = `<span class="font-medium ${isActive ? 'text-indigo-700 dark:text-indigo-300' : 'text-gray-800 dark:text-gray-300'}">${profile.name}</span> ${!isActive ? `<button onclick="event.stopPropagation(); deleteProfile('${profile.id}')" class="text-red-500 hover:text-red-700 text-xs">Borrar</button>` : ''}`;
                el.onclick = () => switchProfile(profile.id);
                list.appendChild(el);
            });
        }
        
        let dragEnabled = false;
        function toggleDragMode(isEnabled) { dragEnabled = isEnabled; showToast(isEnabled ? 'Modo Ordenar Activado' : 'Modo Ordenar Desactivado', 'info'); renderShiftManager(); }
        function renderShiftManager() {
            const list = document.getElementById('shift-list'); list.innerHTML = ''; list.classList.toggle('drag-enabled', dragEnabled);
            activeProfile.shifts.forEach(shift => {
                const el = document.createElement('div'); el.draggable = dragEnabled; el.dataset.shiftId = shift.id;
                el.className = 'draggable-item flex items-center justify-between p-2 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600';
                el.innerHTML = `<div class="flex items-center gap-2 pointer-events-none"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg><span class="w-5 h-5 rounded-full" style="background-color: ${shift.color};"></span><span class="font-medium text-gray-800 dark:text-gray-200">${shift.name}</span></div><div class="space-x-2"><button onclick="editShift('${shift.id}')" class="text-blue-500 text-sm">Editar</button><button onclick="deleteShift('${shift.id}')" class="text-red-500 text-sm">Borrar</button></div>`;
                if (dragEnabled) { el.addEventListener('dragstart', handleDragStart); el.addEventListener('dragend', handleDragEnd); el.addEventListener('touchstart', handleDragStart); }
                list.appendChild(el);
            });
            if (!list.dataset.dragListenersAttached) {
                list.addEventListener('dragover', handleDragOver); list.addEventListener('drop', handleDrop); list.addEventListener('dragleave', handleDragLeave);
                list.addEventListener('touchmove', handleDragOver, { passive: false }); list.addEventListener('touchend', handleDrop); list.dataset.dragListenersAttached = 'true';
            }
        }
        function handleDragStart(e) { const target = e.currentTarget; if(e.dataTransfer) { e.dataTransfer.setData('text/plain', target.dataset.shiftId); e.dataTransfer.effectAllowed = 'move'; } setTimeout(() => { target.classList.add('dragging'); }, 0); }
        function handleDragEnd() { const draggingElement = document.querySelector('.dragging'); if(draggingElement) { draggingElement.classList.remove('dragging'); } document.querySelectorAll('.drop-zone').forEach(zone => zone.remove()); }
        function handleDragOver(e) { if (!dragEnabled) return; const draggingElement = document.querySelector('.dragging'); if (!draggingElement) return; e.preventDefault(); const list = document.getElementById('shift-list'); const clientY = e.clientY ?? e.touches?.[0].clientY; if(clientY === undefined) return; let dropZone = list.querySelector('.drop-zone'); if (!dropZone) { dropZone = document.createElement('div'); dropZone.className = 'drop-zone'; } const afterElement = getDragAfterElement(list, clientY); if (afterElement) { list.insertBefore(dropZone, afterElement); } else { list.appendChild(dropZone); } }
        function handleDragLeave(e) { if (e.relatedTarget && e.currentTarget.contains(e.relatedTarget)) return; document.querySelectorAll('.drop-zone').forEach(zone => zone.remove()); }
        function getDragAfterElement(container, y) { const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')]; return draggableElements.find(child => y < child.getBoundingClientRect().top + child.getBoundingClientRect().height / 2); }
        function handleDrop(e) { if (!dragEnabled) return; const draggingElement = document.querySelector('.dragging'); if (!draggingElement) return; e.preventDefault(); document.querySelectorAll('.drop-zone').forEach(zone => zone.remove()); const draggedShiftId = e.dataTransfer?.getData('text/plain') || draggingElement.dataset.shiftId; const list = document.getElementById('shift-list'); const clientY = e.clientY ?? e.changedTouches?.[0].clientY; if (clientY === undefined) { handleDragEnd(); return; } const afterElement = getDragAfterElement(list, clientY); const shifts = activeProfile.shifts; const draggedIndex = shifts.findIndex(s => s.id === draggedShiftId); const [draggedShift] = shifts.splice(draggedIndex, 1); if (afterElement) { const afterElementId = afterElement.dataset.shiftId; const dropIndex = shifts.findIndex(s => s.id === afterElementId); shifts.splice(dropIndex, 0, draggedShift); } else { shifts.push(draggedShift); } saveToLocalStorage(); renderShiftManager(); }
        
        function updateFreeDayColor(color) { activeProfile.freeDayColor = color; saveToLocalStorage(); renderCurrentCalendar(); }
        function updateConfigControls() { const refDate = new Date(activeProfile.referenceDate); document.getElementById('referenceDate').value = refDate.toISOString().split('T')[0]; document.getElementById('freeDayColorInput').value = activeProfile.freeDayColor || '#16a34a'; }
        function openMenu() { document.getElementById('side-menu').classList.remove('-translate-x-full'); document.getElementById('menu-overlay').classList.remove('hidden'); }
        function closeMenu() { document.getElementById('side-menu').classList.add('-translate-x-full'); document.getElementById('menu-overlay').classList.add('hidden'); }
        function saveShift() { const id = document.getElementById('shift-id').value; const name = document.getElementById('shift-name').value.trim(); const color = document.getElementById('shift-color').value; if (!name) return; if (id) { const shift = activeProfile.shifts.find(s => s.id === id); shift.name = name; shift.color = color; } else { activeProfile.shifts.push({ id: crypto.randomUUID(), name, color }); } saveToLocalStorage(); refreshAllUI(); cancelEdit(); showToast(id ? 'Turno actualizado.' : 'Turno añadido.'); }
        function editShift(id) { const shift = activeProfile.shifts.find(s => s.id === id); document.getElementById('shift-id').value = shift.id; document.getElementById('shift-name').value = shift.name; document.getElementById('shift-color').value = shift.color; document.getElementById('save-shift-btn').textContent = 'Guardar'; document.getElementById('cancel-edit-btn').classList.remove('hidden'); }
        function cancelEdit() { document.getElementById('shift-id').value = ''; document.getElementById('shift-name').value = ''; document.getElementById('shift-color').value = '#3b82f6'; document.getElementById('save-shift-btn').textContent = 'Agregar Turno'; document.getElementById('cancel-edit-btn').classList.add('hidden'); }
        function deleteShift(id) { if (!confirm('¿Seguro?')) return; activeProfile.shifts = activeProfile.shifts.filter(s => s.id !== id); for (const date in activeProfile.assignedShifts) { if (activeProfile.assignedShifts[date] === id) delete activeProfile.assignedShifts[date]; } saveToLocalStorage(); refreshAllUI(); showToast('Turno eliminado.', 'info'); }
        function populateSelectors() { const monthSelect = document.getElementById('displayMonth'); const yearSelect = document.getElementById('displayYear'); const today = new Date(); currentDisplayYear = today.getFullYear(); currentDisplayMonth = today.getMonth(); monthNames.forEach((month, index) => monthSelect.add(new Option(month, index))); for (let i = -5; i <= 5; i++) { yearSelect.add(new Option(currentDisplayYear + i, currentDisplayYear + i)); } }
        function initializeSchedule() { const dateInput = document.getElementById('referenceDate').value; if (!dateInput) { showToast("Selecciona una fecha de inicio.", "error"); return; } activeProfile.referenceDate = new Date(dateInput + "T00:00:00").toISOString(); currentDisplayYear = new Date(activeProfile.referenceDate).getFullYear(); currentDisplayMonth = new Date(activeProfile.referenceDate).getMonth(); saveToLocalStorage(); refreshAllUI(); showToast('Ciclo de trabajo establecido.'); }
        function renderCurrentCalendar() { const wrapper = document.getElementById('calendar-wrapper'); wrapper.innerHTML = createMonthCalendar(currentDisplayYear, currentDisplayMonth); document.getElementById('displayMonth').value = currentDisplayMonth; document.getElementById('displayYear').value = currentDisplayYear; }
        function navigateMonth(direction) { currentDisplayMonth += direction; if (currentDisplayMonth < 0) { currentDisplayMonth = 11; currentDisplayYear--; } else if (currentDisplayMonth > 11) { currentDisplayMonth = 0; currentDisplayYear++; } renderCurrentCalendar(); }
        function jumpToDate() { currentDisplayMonth = parseInt(document.getElementById('displayMonth').value); currentDisplayYear = parseInt(document.getElementById('displayYear').value); renderCurrentCalendar(); }
        
        function calculateDaysUntilNextFreeDay() { const refDate = new Date(activeProfile.referenceDate); const utcReferenceDate = Date.UTC(refDate.getUTCFullYear(), refDate.getUTCMonth(), refDate.getUTCDate()); const today = new Date(); today.setHours(0, 0, 0, 0); for (let i = 0; i < 90; i++) { const checkDate = new Date(today); checkDate.setDate(today.getDate() + i); const utcCheckDate = Date.UTC(checkDate.getUTCFullYear(), checkDate.getUTCMonth(), checkDate.getUTCDate()); const diffDays = Math.round((utcCheckDate - utcReferenceDate) / (1000 * 60 * 60 * 24)); const cyclePosition = ((diffDays % 8) + 8) % 8; if (cyclePosition === 0 || cyclePosition === 1) { return i; } } return -1; }
        function updateCountdown() { const days = calculateDaysUntilNextFreeDay(); const container = document.getElementById('countdown-container'); if (days === 0) { container.textContent = '¡Hoy es tu día libre!'; } else if (days === 1) { container.textContent = 'Falta 1 día para tu próximo día libre.'; } else if (days > 1) { container.textContent = `Faltan ${days} días para tu próximo día libre.`; } else { container.textContent = 'Calculando próximo día libre...'; } }
        function createMonthCalendar(year, month) {
            const firstDayOfMonth = new Date(year, month, 1); let gridStart = (firstDayOfMonth.getDay() + 6) % 7; const daysInMonth = new Date(year, month + 1, 0).getDate();
            let html = `<div id="calendar-to-print" class="calendar-container bg-white dark:bg-gray-800 rounded-lg p-2"><div class="calendar-grid mb-2">${dayNames.map(n=>`<div class="day-name text-gray-600 dark:text-gray-300">${n}</div>`).join('')}</div><div class="calendar-grid">`;
            html += `<div></div>`.repeat(gridStart);
            const refDate = new Date(activeProfile.referenceDate); const utcReferenceDate = Date.UTC(refDate.getUTCFullYear(), refDate.getUTCMonth(), refDate.getUTCDate());
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                const utcCurrentDate = Date.UTC(year, month, day); const diffDays = Math.round((utcCurrentDate - utcReferenceDate) / (1000 * 60 * 60 * 24));
                const cyclePosition = ((diffDays % 8) + 8) % 8; const dateString = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                let dayClass = 'day-cell', style = '', onClick = '', content = `<span class="day-number">${day}</span>`;
                if (isToday) { dayClass += ' today'; }
                if (cyclePosition === 0 || cyclePosition === 1) {
                    const freeDayColor = activeProfile.freeDayColor || '#16a34a';
                    const textColor = getTextColorForBg(freeDayColor);
                    style = `style="background-color: ${freeDayColor}; color: ${textColor};"`;
                    dayClass += ' free-day';
                }
                else {
                    dayClass += ' work-day bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 assignable hover:bg-gray-300 dark:hover:bg-gray-600 cursor-pointer'; onClick = `onclick="openModal('${dateString}')"`;
                    const assignedShiftId = activeProfile.assignedShifts[dateString];
                    if (assignedShiftId) {
                        const shift = activeProfile.shifts.find(s => s.id === assignedShiftId);
                        if (shift) { const textColor = getTextColorForBg(shift.color); style = `style="background-color: ${shift.color}; color: ${textColor};"`; dayClass += ' assigned-shift'; content += `<span class="shift-name-label">${shift.name}</span>`; }
                    }
                }
                html += `<div class="${dayClass}" data-date="${dateString}" ${style} ${onClick}>${content}</div>`;
            }
            return html + `</div></div>`;
        }
        function openModal(dateString) { selectedDateForAssignment = dateString; const modal = document.getElementById('shiftModal'); modal.classList.remove('hidden'); modal.classList.add('flex'); document.getElementById('modal-date').textContent = new Date(dateString + 'T00:00:00').toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}); const optionsContainer = document.getElementById('modal-shift-options'); optionsContainer.innerHTML = ''; activeProfile.shifts.forEach(shift => { const button = document.createElement('button'); button.textContent = shift.name; const textColor = getTextColorForBg(shift.color); button.className = 'w-full font-bold py-2 px-4 rounded-lg active:scale-95 transition-transform'; button.style.backgroundColor = shift.color; button.style.color = textColor; button.onclick = () => assignShift(shift.id); optionsContainer.appendChild(button); }); document.getElementById('google-cal-btn').disabled = !activeProfile.assignedShifts[dateString]; }
        function closeModal(event) { const modal = document.getElementById('shiftModal'); if (event.target === modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); selectedDateForAssignment = null; } }
        function assignShift(shiftId) { if (!selectedDateForAssignment) return; activeProfile.assignedShifts[selectedDateForAssignment] = shiftId; saveToLocalStorage(); document.getElementById('shiftModal').classList.add('hidden'); document.getElementById('shiftModal').classList.remove('flex'); refreshAllUI(); showToast('Turno asignado.'); }
        function removeShiftAssignment() { if (!selectedDateForAssignment) return; delete activeProfile.assignedShifts[selectedDateForAssignment]; saveToLocalStorage(); document.getElementById('shiftModal').classList.add('hidden'); document.getElementById('shiftModal').classList.remove('flex'); refreshAllUI(); showToast('Asignación de turno eliminada.', 'info'); }
        function backupData() { downloadFile(`respaldo_calendario_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(appData, null, 2), 'application/json'); showToast('Respaldo de datos descargado.');}
        function restoreData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = e => { try { const data = JSON.parse(e.target.result); if (data.profiles && data.activeProfileId) { appData = data; switchProfile(data.activeProfileId); showToast("Datos restaurados con éxito."); } else { showToast("Archivo de respaldo no válido.", "error"); } } catch (err) { showToast("Error al leer el archivo.", "error"); } }; reader.readAsText(file); event.target.value = ''; }
        function downloadFile(filename, content, mimeType) { const a = document.createElement('a'); const blob = new Blob([content], {type: mimeType}); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href); }
        function exportToCSV() { let csvContent = "Fecha,Dia,Tipo,Turno\n"; const daysInMonth = new Date(currentDisplayYear, currentDisplayMonth + 1, 0).getDate(); const refDate = new Date(activeProfile.referenceDate); for (let day = 1; day <= daysInMonth; day++) { const date = new Date(currentDisplayYear, currentDisplayMonth, day); const dateStr = date.toISOString().slice(0, 10); const dayName = dayNamesFull[date.getDay()]; const diffDays = Math.round((date.getTime() - refDate.getTime()) / (1000 * 60 * 60 * 24)); const cyclePos = ((diffDays % 8) + 8) % 8; const type = (cyclePos === 0 || cyclePos === 1) ? "Libre" : "Trabajo"; let shiftName = ""; if (type === "Trabajo") { const shiftId = activeProfile.assignedShifts[dateStr]; if (shiftId) { const shift = activeProfile.shifts.find(s => s.id === shiftId); shiftName = shift ? `"${shift.name}"` : ""; } } csvContent += `${dateStr},${dayName},${type},${shiftName}\n`; } const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); downloadFile(`horario_${activeProfile.name}_${currentDisplayYear}-${currentDisplayMonth+1}.csv`, blob, 'text/csv;charset=utf-8;'); showToast('Exportado a Excel (CSV).'); }
        async function exportToPDF() { const btn = document.getElementById('pdf-export-btn'); const originalText = btn.textContent; btn.textContent = 'Generando...'; btn.disabled = true; const calendarEl = document.getElementById('calendar-to-print'); const bgColor = document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff'; try { const canvas = await html2canvas(calendarEl, { scale: 3, backgroundColor: bgColor }); const imgData = canvas.toDataURL('image/png'); const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' }); const pdfWidth = pdf.internal.pageSize.getWidth(); const margin = 40; const contentWidth = pdfWidth - margin * 2; const ratio = canvas.height / canvas.width; const contentHeight = contentWidth * ratio; pdf.setFontSize(20); pdf.text(`${activeProfile.name} - ${monthNames[currentDisplayMonth]} ${currentDisplayYear}`, pdfWidth / 2, margin, { align: 'center' }); pdf.addImage(imgData, 'PNG', margin, margin + 20, contentWidth, contentHeight); pdf.save(`horario_${activeProfile.name}_${currentDisplayYear}-${currentDisplayMonth+1}.pdf`); showToast('Exportado a PDF.'); } catch (error) { console.error("Error al exportar a PDF:", error); showToast('Error al generar el PDF.', 'error'); } finally { btn.textContent = originalText; btn.disabled = false; } }
        function addToGoogleCalendar() { if (!selectedDateForAssignment) return; const shiftId = activeProfile.assignedShifts[selectedDateForAssignment]; if (!shiftId) { showToast("Primero asigna un turno a este día.", "error"); return; } const shift = activeProfile.shifts.find(s => s.id === shiftId); const times = shift.name.match(/(\d{2}):(\d{2})[ -]+(\d{2}):(\d{2})/); if (!times) { showToast("Formato de turno no válido para exportar.", "error"); return; } const [, startHour, startMin, endHour, endMin] = times.map(t => parseInt(t)); let startDate = new Date(`${selectedDateForAssignment}T${times[1]}:${times[2]}:00`); let endDate = new Date(startDate); endDate.setHours(endHour, endMin, 0, 0); if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); } const toGoogleFormat = (date) => date.toISOString().replace(/-|:|\.\d{3}/g, ''); const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(shift.name)}&dates=${toGoogleFormat(startDate)}/${toGoogleFormat(endDate)}&details=Turno asignado desde el planificador.`; window.open(url, '_blank'); }
        function openImportModal() { const modal = document.getElementById('importShiftModal'); const optionsContainer = document.getElementById('import-profile-options'); optionsContainer.innerHTML = ''; const otherProfiles = appData.profiles.filter(p => p.id !== activeProfile.id); if (otherProfiles.length === 0) { optionsContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No hay otros perfiles desde donde importar.</p>`; } else { otherProfiles.forEach(profile => { const button = document.createElement('button'); button.textContent = `Importar de "${profile.name}"`; button.className = 'w-full font-bold py-2 px-4 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200'; button.onclick = () => importShiftsFromProfile(profile.id); optionsContainer.appendChild(button); }); } modal.classList.remove('hidden'); modal.classList.add('flex'); }
        function closeImportModal(event) { const modal = document.getElementById('importShiftModal'); if (!event || event.target === modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); } }
        function importShiftsFromProfile(sourceProfileId) { const sourceProfile = appData.profiles.find(p => p.id === sourceProfileId); if (!sourceProfile) { showToast('Perfil de origen no encontrado.', 'error'); return; } sourceProfile.shifts.forEach(sourceShift => { const newShift = { id: crypto.randomUUID(), name: sourceShift.name, color: sourceShift.color }; activeProfile.shifts.push(newShift); }); saveToLocalStorage(); refreshAllUI(); closeImportModal(); showToast(`Turnos importados desde "${sourceProfile.name}".`, 'success'); }

        window.onload = () => { 
            populateSelectors(); 
            loadFromLocalStorage(); 
            refreshAllUI();
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                .then(registration => console.log('Service Worker registrado con éxito:', registration))
                .catch(error => console.log('Error al registrar el Service Worker:', error));
            }
        };
    </script>
</body>
</html>


